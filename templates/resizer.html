{% extends "base.html" %}

{% block title %}Billedbehandling - DGB V√¶rkt√∏jer{% endblock %}

{% block content %}
    <h1>üñºÔ∏è Billedbehandling og gruppering</h1>
    <p class="muted">Upload mange billeder og organiser dem i grupper med automatisk omd√∏bning og st√∏rrelsestilpasning.</p>

    {% if error %}
    <div class="card">
        <div class="alert">{{ error }}</div>
    </div>
    {% endif %}

    {% if not step %}
    <div class="main-container">
        <!-- Left side: Upload and image library -->
        <div class="left-panel">
            <div class="card">
                <h2>1. Upload billeder</h2>
                <div class="upload-area" id="upload-area">
                    <div class="upload-placeholder">
                        <p>üìÅ Tr√¶k billeder hertil eller klik for at v√¶lge</p>
                        <input type="file" id="file-input" multiple accept="image/*" style="display: none;">
                        <button type="button" onclick="document.getElementById('file-input').click()">V√¶lg billeder</button>
                    </div>
                </div>
                
                <div id="uploaded-images" class="uploaded-images-section" style="display: none;">
                    <h3>Billedbibliotek</h3>
                    <p class="muted">Tr√¶k billeder til h√∏jre side for at organisere dem i grupper</p>
                    <div id="image-thumbnails" class="image-thumbnails"></div>
                </div>
            </div>
        </div>

        <!-- Right side: Grouping and settings -->
        <div class="right-panel">
            <div class="card" id="grouping-section" style="display: none;">
                <h2>2. Organiser i grupper</h2>
                
                <div class="group-controls">
                    <button type="button" id="add-group-btn">+ Tilf√∏j ny gruppe</button>
                </div>
                
                <div id="groups-container" class="groups-container"></div>
                
                <div class="settings-section">
                    <h3>3. Indstillinger</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="small-size">Sm√• billeder (maks):</label>
                            <input type="number" id="small-size" value="300" min="50" max="1000" step="50"> KB
                        </div>
                        <div class="setting-item full-width">
                            <label>
                                <input type="checkbox" id="use-aab-prefix" checked> Brug "AAB" prefix
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="spacer"></div>
                <button type="button" id="process-btn" class="process-button" disabled>Behandl billeder</button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if step == 'results' %}
    <!-- Step 3: Results -->
    <div class="card">
        <h2>‚úÖ Billeder behandlet!</h2>
        <div class="success">
            {{ processed_count }} billedpar blev behandlet og organiseret.
        </div>
        
        <p>Hver gruppe indeholder:</p>
        <ul>
            <li><strong>Sm√• billeder</strong> - Komprimeret til max st√∏rrelse (KB-baseret)</li>
            <li><strong>Store billeder</strong> - Original kvalitet med minimal √¶ndring</li>
        </ul>
        
        <p class="muted"><strong>Bem√¶rk:</strong> Begge versioner har samme filnavn, men er placeret i separate mapper (small/ og large/)</p>
        
        <div class="spacer"></div>
        <div class="row">
            <div class="col">
                <a href="{{ url_for('resizer.download_zip', token=group_token) }}" class="button">
                    üì¶ Download alle billeder (ZIP)
                </a>
            </div>
            <div class="col">
                <a href="{{ url_for('resizer.view') }}" class="button" style="background: #6c757d;">
                    üîÑ Start forfra
                </a>
            </div>
        </div>
    </div>
    {% endif %}

<style>
/* Main layout: 2-column design */
.main-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

.left-panel, .right-panel {
    min-height: 500px;
}

/* Upload area styling */
.upload-area {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    background: #f8fafc;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: 20px;
}

.upload-area:hover, .upload-area.dragover {
    border-color: var(--accent);
    background: #e0e7ff;
}

.upload-placeholder p {
    font-size: 1.1rem;
    color: var(--muted);
    margin: 0 0 16px 0;
}

/* Image thumbnails grid - Square images */
.image-thumbnails {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 16px;
    max-height: 400px;
    overflow-y: auto;
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fefefe;
    position: relative; /* For selection rectangle */
    user-select: none; /* Prevent text selection during drag */
}

/* Make entire uploaded images section selectable */
.uploaded-images-section {
    position: relative;
    user-select: none;
}

.image-thumb {
    position: relative;
    border: 2px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    cursor: grab;
    transition: all 0.1s ease; /* Even faster */
    background: white;
    aspect-ratio: 1; /* Force square aspect ratio */
}

.image-thumb:active {
    cursor: grabbing;
}

.image-thumb.selected {
    border-color: #3b82f6;
    background: #dbeafe;
    transform: scale(0.95);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}

.image-thumb.dragging {
    opacity: 0.8;
    transform: scale(1.05) rotate(3deg);
    z-index: 1000;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    cursor: grabbing !important;
}

/* Selection rectangle */
.selection-rectangle {
    position: absolute;
    border: 2px dashed #3b82f6;
    background: rgba(59, 130, 246, 0.15);
    pointer-events: none;
    z-index: 999;
    display: none;
    border-radius: 4px;
}

/* Drag preview */
.drag-preview {
    position: fixed;
    pointer-events: none;
    z-index: 1001;
    background: white;
    border: 2px solid #3b82f6;
    border-radius: 8px;
    padding: 4px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    transform: rotate(5deg);
    font-size: 0.8rem;
    color: #1f2937;
}

.image-thumb:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.image-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Crop to fill square */
    display: block;
}

.image-thumb .info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 4px;
    font-size: 0.7rem;
    color: white;
    text-align: center;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

/* Groups styling - improved for right panel */
.group-controls {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.group-controls button {
    padding: 10px 16px;
    font-size: 0.9rem;
}

.groups-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-height: 500px;
    overflow-y: auto;
    padding: 8px;
}

.group-item {
    border: 2px solid #94a3b8;
    border-radius: 12px;
    padding: 16px;
    background: #f8fafc;
    transition: all 0.3s ease;
}

.group-item.drag-over {
    border-color: var(--accent);
    background: #e0e7ff;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
}

.group-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.group-header input {
    flex: 1;
    padding: 8px 12px;
    border: 2px solid var(--border);
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    background: white;
}

.group-header input:focus {
    border-color: var(--accent);
    outline: none;
}

.group-header .delete-group {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: background 0.2s;
}

.group-header .delete-group:hover {
    background: #dc2626;
}

.group-images {
    display: grid;
    grid-template-columns: repeat(auto-fill, 40px);
    grid-auto-rows: 40px;
    gap: 4px;
    min-height: 50px;
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 6px;
    background: white;
    transition: all 0.3s ease;
}

.group-images.empty::after {
    content: "üìÅ Drop her";
    color: var(--muted);
    font-size: 0.7rem;
    grid-column: 1 / -1;
    text-align: center;
    padding: 8px;
    background: #f1f5f9;
    border-radius: 6px;
    border: 1px dashed #cbd5e1;
}

.group-image {
    position: relative;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: white;
    transition: all 0.3s ease;
    width: 40px;
    height: 40px;
}

.group-image:hover {
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.group-image img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Crop to fill square */
    display: block;
}

.group-image .letter-label {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: rgba(0,0,0,0.8);
    color: white;
    font-size: 0.7rem;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 3px;
}

.group-image .remove-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    font-size: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Settings section - compact design */
.settings-section {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.setting-item.full-width {
    grid-column: 1 / -1;
}

.setting-item label {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 4px;
}

.setting-item input[type="number"] {
    width: 100%;
    padding: 6px 8px;
    font-size: 0.9rem;
}

.process-button {
    background: linear-gradient(#10b981, #059669);
    color: white;
    border: 1px solid #059669;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
}

.process-button:disabled {
    background: #94a3b8;
    border-color: #94a3b8;
    cursor: not-allowed;
}

.process-button:not(:disabled):hover {
    background: linear-gradient(#059669, #047857);
}

/* Dragging states */
.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
}

.drop-zone-active {
    border-color: var(--accent) !important;
    background: #e0e7ff !important;
}

/* Responsive design */
@media (max-width: 1024px) {
    .main-container {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .settings-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    const uploadedImages = document.getElementById('uploaded-images');
    const imageThumbnails = document.getElementById('image-thumbnails');
    const groupingSection = document.getElementById('grouping-section');
    const groupsContainer = document.getElementById('groups-container');
    const processBtn = document.getElementById('process-btn');
    
    let uploadedImageData = [];
    let groups = [];
    let draggedElement = null;
    let selectedImages = new Set(); // Track selected images
    let isSelecting = false;
    let selectionStart = { x: 0, y: 0 };
    let selectionRect = null;

    // Create selection rectangle element
    function createSelectionRectangle() {
        const rect = document.createElement('div');
        rect.className = 'selection-rectangle';
        uploadedImagesSection.appendChild(rect);
        return rect;
    }

    // Multi-select functionality - works on entire uploaded images section
    const uploadedImagesSection = document.getElementById('uploaded-images');
    
    uploadedImagesSection.addEventListener('mousedown', function(e) {
        if (e.target.closest('.image-thumb')) {
            const thumb = e.target.closest('.image-thumb');
            const imageIndex = parseInt(thumb.dataset.imageIndex);
            
            if (e.ctrlKey || e.metaKey) {
                // Toggle selection with Ctrl/Cmd click
                toggleSelection(thumb, imageIndex);
            } else if (!selectedImages.has(imageIndex)) {
                // Clear selection and select this one
                clearSelection();
                toggleSelection(thumb, imageIndex);
            }
            return;
        }
        
        // Start rectangle selection anywhere in the uploaded images area
        if (!e.target.closest('button') && !e.target.closest('input')) {
            startSelection(e);
        }
    });

    function startSelection(e) {
        isSelecting = true;
        clearSelection();
        
        const rect = uploadedImagesSection.getBoundingClientRect();
        selectionStart.x = e.clientX - rect.left;
        selectionStart.y = e.clientY - rect.top;
        
        if (!selectionRect) {
            selectionRect = createSelectionRectangle();
        }
        
        selectionRect.style.display = 'block';
        selectionRect.style.left = selectionStart.x + 'px';
        selectionRect.style.top = selectionStart.y + 'px';
        selectionRect.style.width = '0px';
        selectionRect.style.height = '0px';
        
        e.preventDefault();
    }

    document.addEventListener('mousemove', function(e) {
        if (!isSelecting || !selectionRect) return;
        
        const rect = uploadedImagesSection.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        const left = Math.min(selectionStart.x, currentX);
        const top = Math.min(selectionStart.y, currentY);
        const width = Math.abs(currentX - selectionStart.x);
        const height = Math.abs(currentY - selectionStart.y);
        
        selectionRect.style.left = left + 'px';
        selectionRect.style.top = top + 'px';
        selectionRect.style.width = width + 'px';
        selectionRect.style.height = height + 'px';
        
        // Select images within rectangle
        selectImagesInRectangle(left, top, width, height);
    });

    document.addEventListener('mouseup', function() {
        if (isSelecting) {
            isSelecting = false;
            if (selectionRect) {
                selectionRect.style.display = 'none';
            }
        }
    });

    function selectImagesInRectangle(left, top, width, height) {
        const thumbs = imageThumbnails.querySelectorAll('.image-thumb');
        
        thumbs.forEach(thumb => {
            const thumbRect = thumb.getBoundingClientRect();
            const containerRect = imageThumbnails.getBoundingClientRect();
            
            const thumbLeft = thumbRect.left - containerRect.left + imageThumbnails.scrollLeft;
            const thumbTop = thumbRect.top - containerRect.top + imageThumbnails.scrollTop;
            const thumbRight = thumbLeft + thumb.offsetWidth;
            const thumbBottom = thumbTop + thumb.offsetHeight;
            
            const selectionRight = left + width;
            const selectionBottom = top + height;
            
            // Check if rectangles overlap
            const overlaps = !(thumbRight < left || thumbLeft > selectionRight || 
                            thumbBottom < top || thumbTop > selectionBottom);
            
            const imageIndex = parseInt(thumb.dataset.imageIndex);
            
            if (overlaps) {
                addToSelection(thumb, imageIndex);
            } else {
                removeFromSelection(thumb, imageIndex);
            }
        });
    }

    function toggleSelection(thumb, imageIndex) {
        if (selectedImages.has(imageIndex)) {
            removeFromSelection(thumb, imageIndex);
        } else {
            addToSelection(thumb, imageIndex);
        }
    }

    function addToSelection(thumb, imageIndex) {
        selectedImages.add(imageIndex);
        thumb.classList.add('selected');
    }

    function removeFromSelection(thumb, imageIndex) {
        selectedImages.delete(imageIndex);
        thumb.classList.remove('selected');
    }

    function clearSelection() {
        selectedImages.clear();
        document.querySelectorAll('.image-thumb.selected').forEach(thumb => {
            thumb.classList.remove('selected');
        });
    }

    // File upload handling
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);

    function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        uploadFiles(files);
    }

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        uploadFiles(files);
    }

    function uploadFiles(files) {
        const imageFiles = files.filter(file => file.type.startsWith('image/'));
        if (imageFiles.length === 0) {
            alert('Kun billedfiler er tilladt');
            return;
        }

        // Process each file
        imageFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Create a smaller thumbnail for faster performance
                createThumbnail(e.target.result, 150, 150).then(thumbnailSrc => {
                    const imageData = {
                        file: file,
                        src: e.target.result,  // Keep original for processing
                        thumbnailSrc: thumbnailSrc,  // Small version for display
                        name: file.name,
                        size: file.size
                    };
                    uploadedImageData.push(imageData);
                    displayUploadedImage(imageData, uploadedImageData.length - 1);
                });
            };
            reader.readAsDataURL(file);
        });

        // Show uploaded images section
        uploadedImages.style.display = 'block';
        groupingSection.style.display = 'block';
    }

    // Create optimized thumbnail for fast display
    function createThumbnail(src, maxWidth, maxHeight) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate new dimensions maintaining aspect ratio
                let { width, height } = img;
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw resized image with better quality for clarity
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.85)); // Higher quality for thumbnails
            };
            img.src = src;
        });
    }

    function displayUploadedImage(imageData, index) {
        const thumb = document.createElement('div');
        thumb.className = 'image-thumb';
        thumb.draggable = true;
        thumb.dataset.imageIndex = index;
        
        thumb.innerHTML = `
            <img src="${imageData.thumbnailSrc || imageData.src}" alt="${imageData.name}">
            <div class="info">${imageData.name}</div>
        `;

        thumb.addEventListener('dragstart', function(e) {
            const imageIndex = parseInt(this.dataset.imageIndex);
            
            // If this image isn't selected, clear selection and select only this one
            if (!selectedImages.has(imageIndex)) {
                clearSelection();
                addToSelection(this, imageIndex);
            }
            
            draggedElement = this;
            this.classList.add('dragging');
            
            // Add dragging class to all selected images for visual feedback
            document.querySelectorAll('.image-thumb.selected').forEach(t => {
                t.classList.add('dragging');
            });
            
            // Create drag preview.
            const selectedCount = selectedImages.size;
            const dragPreview = document.createElement('div');
            dragPreview.className = 'drag-preview';
            dragPreview.textContent = selectedCount > 1 ? `${selectedCount} billeder` : '1 billede';
            dragPreview.style.left = '-1000px';
            dragPreview.style.top = '-1000px';
            document.body.appendChild(dragPreview);
            
            // Use the preview as drag image
            e.dataTransfer.setDragImage(dragPreview, 50, 20);
            
            // Clean up preview after drag starts
            setTimeout(() => {
                if (document.body.contains(dragPreview)) {
                    document.body.removeChild(dragPreview);
                }
            }, 1);
            
            // Store all selected images for drag operation
            const selectedData = Array.from(selectedImages);
            e.dataTransfer.setData('application/json', JSON.stringify({
                type: 'multiple-images',
                imageIndices: selectedData
            }));
            e.dataTransfer.effectAllowed = 'move';
        });

        thumb.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            // Remove dragging class from all selected images
            document.querySelectorAll('.image-thumb.selected').forEach(t => {
                t.classList.remove('dragging');
            });
            draggedElement = null;
        });

        imageThumbnails.appendChild(thumb);
    }

    // Group management - ensure button works after groups are deleted
    function setupGroupButton() {
        const addGroupBtn = document.getElementById('add-group-btn');
        if (addGroupBtn) {
            console.log('Setting up add group button');
            // Remove existing listener and add new one to prevent duplicates
            addGroupBtn.removeEventListener('click', handleAddGroup);
            addGroupBtn.addEventListener('click', handleAddGroup);
            // Ensure button is enabled
            addGroupBtn.disabled = false;
        } else {
            console.error('Add group button not found');
        }
    }
    
    function handleAddGroup() {
        console.log('Add group button clicked');
        addGroup();
    }
    
    // Initialize button
    setupGroupButton();

    function addGroup(name = '') {
        console.log('Adding new group, current groups:', groups.length);
        
        const groupId = 'group-' + Date.now();
        const group = {
            id: groupId,
            name: name || `Gruppe ${groups.length + 1}`,
            images: []
        };
        groups.push(group);

        const groupElement = createGroupElement(group);
        const container = document.getElementById('groups-container');
        if (container) {
            container.appendChild(groupElement);
            console.log('Group added successfully:', groupId);
        } else {
            console.error('Could not find groups container');
        }
        
        updateProcessButton();
        return groupElement;
    }

    function createGroupElement(group) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group-item';
        groupDiv.dataset.groupId = group.id;
        
        groupDiv.innerHTML = `
            <div class="group-header">
                <input type="text" value="${group.name}" placeholder="Gruppenavn (fx: 1234x1234)">
                <button type="button" class="delete-group">Slet</button>
            </div>
            <div class="group-images empty" data-group-id="${group.id}"></div>
        `;

        // Event listeners
        const nameInput = groupDiv.querySelector('input');
        nameInput.addEventListener('input', function() {
            group.name = this.value;
            updateProcessButton();
        });

        const deleteBtn = groupDiv.querySelector('.delete-group');
        deleteBtn.addEventListener('click', function() {
            deleteGroup(group.id);
        });

        const dropZone = groupDiv.querySelector('.group-images');
        setupDropZone(dropZone, group);

        return groupDiv;
    }

    function setupDropZone(dropZone, group) {
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drop-zone-active');
        });

        dropZone.addEventListener('dragleave', function(e) {
            this.classList.remove('drop-zone-active');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drop-zone-active');
            
            // Try to get multiple images data
            try {
                const dragData = e.dataTransfer.getData('application/json');
                if (dragData) {
                    const data = JSON.parse(dragData);
                    if (data.type === 'multiple-images' && data.imageIndices) {
                        // Handle multiple images
                        data.imageIndices.forEach(imageIndex => {
                            addImageToGroup(group, imageIndex);
                        });
                        
                        // Remove selected images from thumbnails
                        data.imageIndices.forEach(imageIndex => {
                            const thumb = document.querySelector(`[data-image-index="${imageIndex}"]`);
                            if (thumb) thumb.remove();
                        });
                        
                        clearSelection();
                        refreshGroupImages(group);
                        updateProcessButton();
                        return;
                    }
                }
            } catch (e) {
                // Fall back to single image handling
            }
            
            // Single image fallback
            if (draggedElement) {
                const imageIndex = parseInt(draggedElement.dataset.imageIndex);
                addImageToGroup(group, imageIndex);
                draggedElement.remove();
                refreshGroupImages(group);
                updateProcessButton();
            }
        });
    }

    function addImageToGroup(group, imageIndex) {
        // Don't add if already in group
        if (group.images.includes(imageIndex)) return;
        
        const imageData = uploadedImageData[imageIndex];
        group.images.push(imageIndex);
        updateProcessButton();
    }

    window.removeImageFromGroup = function(groupId, imageIndexInGroup) {
        const group = groups.find(g => g.id === groupId);
        if (group) {
            group.images.splice(imageIndexInGroup, 1);
            refreshGroupImages(group);
            updateProcessButton();
        }
    };

    function refreshGroupImages(group) {
        const groupImagesDiv = document.querySelector(`[data-group-id="${group.id}"].group-images`);
        if (!groupImagesDiv) {
            console.error('Could not find group images div for group:', group.id);
            return;
        }
        
        groupImagesDiv.innerHTML = '';
        
        if (group.images.length === 0) {
            groupImagesDiv.classList.add('empty');
        } else {
            groupImagesDiv.classList.remove('empty');
            group.images.forEach((imageIndex, i) => {
                const imageData = uploadedImageData[imageIndex];
                const imageDiv = document.createElement('div');
                imageDiv.className = 'group-image';
                imageDiv.innerHTML = `
                    <img src="${imageData.thumbnailSrc || imageData.src}" alt="${imageData.name}">
                    <div class="letter-label">${String.fromCharCode(97 + i)}</div>
                    <button type="button" class="remove-btn" onclick="removeImageFromGroup('${group.id}', ${i})">√ó</button>
                `;
                groupImagesDiv.appendChild(imageDiv);
            });
        }
    }

    function deleteGroup(groupId) {
        console.log('Deleting group:', groupId);
        
        // Remove from data structure
        groups = groups.filter(g => g.id !== groupId);
        
        // Find the group-item (parent container) specifically
        const groupElement = document.querySelector(`.group-item[data-group-id="${groupId}"]`);
        if (groupElement) {
            groupElement.remove();
            console.log('Group element removed successfully');
        } else {
            console.error('Could not find group element to delete:', groupId);
        }
        
        updateProcessButton();
        // Re-setup the add button to ensure it still works
        setupGroupButton();
    }

    function updateProcessButton() {
        const hasValidGroups = groups.some(g => g.images.length > 0 && g.name.trim() !== '');
        processBtn.disabled = !hasValidGroups;
    }

    // Process groups
    processBtn.addEventListener('click', function() {
        const validGroups = groups.filter(g => g.images.length > 0 && g.name.trim() !== '');
        
        if (validGroups.length === 0) {
            alert('Tilf√∏j mindst √©n gruppe med billeder');
            return;
        }

        // Prepare form data
        const formData = new FormData();
        
        // Add all uploaded files to FormData
        uploadedImageData.forEach((imageData, index) => {
            formData.append('images', imageData.file);
        });
        
        // Prepare groups data with image indices
        const groupsData = validGroups.map(group => ({
            name: group.name.trim(),
            images: group.images  // These are indices into uploadedImageData
        }));

        formData.append('groups_data', JSON.stringify(groupsData));
        formData.append('small_max_size', document.getElementById('small-size').value);
        if (document.getElementById('use-aab-prefix').checked) {
            formData.append('use_aab_prefix', 'on');
        }

        // Show loading
        processBtn.textContent = 'Behandler...';
        processBtn.disabled = true;

        // Submit form
        fetch('{{ url_for("resizer.view") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.text();
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .then(html => {
            // Replace current page content with response
            document.body.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fejl ved behandling af billeder');
            processBtn.textContent = 'Behandl billeder';
            updateProcessButton();
        });
    });
});
</script>

{% endblock %}